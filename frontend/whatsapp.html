<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIVOSY ì™“ì¸ ì•± ë©”ì‹ ì €</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #111b21; color: #e9edef; display: flex; flex-direction: column; height: 100vh; }
        
        /* í—¤ë” */
        header { background: #202c33; padding: 10px 20px; display: flex; align-items: center; border-bottom: 1px solid #374045; }
        header h2 { font-size: 16px; margin: 0; color: #00a884; }

        /* ëŒ€í™”ì°½ (ìœ„ìª½) */
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); /* ì™“ì¸ ì•± ë°°ê²½ ëŠë‚Œ */ }
        
        .bubble { max-width: 70%; padding: 8px 12px; border-radius: 8px; font-size: 14px; line-height: 1.5; position: relative; }
        .user { align-self: flex-end; background: #005c4b; color: #e9edef; border-bottom-right-radius: 2px; }
        .ai { align-self: flex-start; background: #202c33; color: #e9edef; border-bottom-left-radius: 2px; }
        .thinking { font-size: 11px; color: #8696a0; margin-bottom: 4px; display: block; }

        /* ì…ë ¥ì°½ (ì•„ë˜ìª½) */
        footer { background: #202c33; padding: 10px; display: flex; gap: 10px; align-items: flex-end; }
        textarea { flex: 1; background: #2a3942; color: white; border: none; border-radius: 8px; padding: 10px; font-size: 15px; resize: none; outline: none; height: 45px; }
        button { background: #00a884; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; font-weight: bold; flex-shrink: 0; }
        button:disabled { background: #555; }
    </style>
</head>
<body>
    <header>
        <h2>ğŸŸ¢ 14B ê³¼ì¥ë‹˜ (Active Now)</h2>
    </header>

    <div id="chat-window">
        <div class="bubble ai">ê³µì¥ì¥ë‹˜, ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? (Master Truth í™œì„±í™”ë¨)</div>
    </div>

    <footer>
        <textarea id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="handleEnter(event)"></textarea>
        <button id="send-btn" onclick="send()">ì „ì†¡</button>
    </footer>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const msgField = document.getElementById('msg');
        const sendBtn = document.getElementById('send-btn');

        // ì—”í„°ì¹˜ë©´ ë°”ë¡œ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                send();
            }
        }

        async function send() {
            const content = msgField.value.trim();
            if(!content) return;

            // 1. ì‚¬ìš©ì ë©”ì‹œì§€ í™”ë©´ì— ì¶”ê°€
            addBubble('user', content);
            msgField.value = ''; // ì…ë ¥ì°½ ì¦‰ì‹œ ë¹„ìš°ê¸° (delí‚¤ ë…¸ê°€ë‹¤ í•´ë°©!)
            msgField.style.height = '45px';

            sendBtn.disabled = true;

            try {
                const res = await fetch('/api/whatsapp', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sender: 'ê³µì¥ì¥(WhatsApp)', 
                        content: content,
                        channel: 'whatsapp'
                    })
                });

                const data = await res.json();

                if(res.ok) {
                    // 2. AI ëŒ€ë‹µ í™”ë©´ì— ì¶”ê°€
                    const aiText = data.summary || data.raw || "ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    const thinking = data.thinking ? `ğŸ’­ ${data.thinking}` : "";
                    addBubble('ai', aiText, thinking);
                }
            } catch(e) {
                addBubble('ai', "âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨! ê¹€ìˆ˜ì„ì„ ë¶ˆëŸ¬ì£¼ì„¸ìš”.");
            } finally {
                sendBtn.disabled = false;
                chatWindow.scrollTop = chatWindow.scrollHeight; // ìµœì‹  ëŒ€í™”ë¡œ ìŠ¤í¬ë¡¤
            }
        }

        function addBubble(type, text, thinking = "") {
            const div = document.createElement('div');
            div.className = `bubble ${type}`;
            
            let html = "";
            if(thinking) html += `<span class="thinking">${thinking}</span>`;
            html += `<span>${text}</span>`;
            
            div.innerHTML = html;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
</body>
</html>